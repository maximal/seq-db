# SeqQL

## Полнотекстовый поиск

Полнотекстовый поиск в SeqQL позволяет фильтровать результат по токенам документов.
Запросы могут содержать точные фразы или ключевые слова, разделенные пробелами.
Это поведение зависит от типа индекса, подробнее о формировании токенов смотрите [виды индексов](index-types).
При выполнении полнотекстового поиска система автоматически отбирает результаты, соответствующие
заданному тексту.

По умолчанию поиск не чувствителен к регистру.
Это конфигурируется с помощью параметра `--case-sensitive` и влияет только на новые документы.

## Логические операторы

SeqQL поддерживает логические операторы для более точного фильтра поиска. Операторы `and`, `or`, `not` позволяют
комбинировать и усложнять запросы:

- `and` — используется для поиска, где оба условия должны быть истинными.
- `or` — возвращает результаты, если одно из условий выполняется.
- `not` — исключает результаты, соответствующие указанному условию.

Примеры:

```seq-ql
message:error and level:critical
message:login or message:logout
not level:debug
```

## Подстановочные символы

Wildcards, или "подстановочные символы", в SeqQL позволяют производить поиск по частичному совпадению.
Язык поддерживает следующие символы:

- `*` — заменяет любое количество символов.

Эти символы можно использовать для поиска на уровне отдельного токена или его части.
Например, запрос [keyword](03-index-types.md#keyword) индекса `source_type:access*`
найдет все документы, начинающиеся с `access`.

## Фильтр `range`

SeqQL позволяет использовать диапазоны значений (range) для фильтрации данных. Это особенно полезно для числовых
значений, таких как размеры или время. Диапазоны задаются с использованием квадратных или круглых скобок:

- `[a, b]` — включает границы диапазона.
- `(a, b)` — исключает границы диапазона.

Пример использования диапазона:

```seq-ql
bytes:(100, 1000]
bytes:[100, 1000)
```

## Фильтр `in`

SeqQL позволяет использовать фильтр `in` для фильтрации списка токенов.
Синтаксис полнотекстового поиска такой же как и в [полнотекстовом поиске](#полнотекстовый-поиск) с поддержкой всех видов
строковых литералов, поисковые токены должны быть разделены запятой.

Пример использования `in`:

```seq-ql
level:error and k8s_namespace:in(default, kube-system) and k8s_pod:in(kube-proxy-*, kube-apiserver-*, kube-scheduler-*)

trace_id:in(123e4567-e89b-12d3-a456-426655440000, '123e4567-e89b-12d3-a456-426655440001', "123e4567-e89b-12d3-a456-426655440002",`123e4567-e89b-12d3-a456-426655440003`)
```

## Pipes

Pipes в SeqQL — это механизм для последовательной обработки данных.
Pipes позволяют трансформировать, обогащать, фильтровать, агрегировать данные и форматировать результаты.

#### `fields` pipe

Pipe `fields` позволяет удалить лишние поля у документов в выдаче.
Это может пригодиться, когда нужно оставить только нужные поля,
также это особенно полезно при экспорте большого числа данных,
чтобы сократить нагрузку на передачу по сети.

Перечисленные поля могут не входить в [mapping](04-mapping.md)
и их наличие не влияет на производительность `fields` pipe.

Пример:

```seq-ql
source_type:access* | fields user, KB
```

В итоговом результате у каждого документа будут только поля `user` и `KB`.

Чтобы удалить только перечисленные поля, воспользуйтесь ключевым словом `except`, пример:

```seq-ql
source_type:access* | fields except payload, cookies
```

В этом примере поля `payload`, `cookies` будут исключены из результата.

## Рекомендации по оптимизации запросов в SeqQL

Оптимизация запросов в SeqQL позволяет эффективно обрабатывать большие объемы данных и получать нужные результаты
быстрее, снижая нагрузку на систему.
Основная цель оптимизации заключается в минимизации объема обрабатываемых данных на каждом этапе обработки.

Ниже перечислены ключевые рекомендации для оптимизации запросов SeqQL:

### Максимальная фильтрация на стадии первичного поиска

При составлении запроса старайтесь отфильтровать как можно больше данных на уровне первичного поиска.
Уточняйте условия поиска, задавая конкретные поля (например, `source_type`, `status`, `date`), чтобы
отсеять ненужные данные и сократить их объем перед обработкой пайпами.
Использование более узкого диапазона значений, таких как временные интервалы или точные значения для
индексов, например, `source_type:access* AND date:[2023-01-01, 2023-12-31]`, отсекает нерелевантные данные до
дальнейшей обработки.

### Сокращение возвращаемых полей

Указывайте только те поля, которые вам нужны, чтобы уменьшить объем данных и ускорить обработку запроса.
Используйте форматирующий пайп `fields`, чтобы выбрать только важные поля:

```
source_type:access* |  fields KB, status, timestamp
```

Здесь итоговый результат включает только указанные поля `KB`, `status` и `timestamp`, что экономит память и
уменьшает время вывода результатов.
